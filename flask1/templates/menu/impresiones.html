{% extends '_appgui.html' %}
{% block content %}
<style>
    .select2-selection__rendered {
        line-height: 33px !important;
    }
    .select2-container .select2-selection--single {
        height: 37px !important;
    }
    .select2-selection__arrow {
        height: 34px !important;
    }
</style>

<div class="card card-body bg-light">
    <h3 class="card-header">Impresiones hechas</h3>
    <div class="card-block">
        <table class="table table-sm table-striped table-hover">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Pieza</th>
              <th>Cantidad</th>
            </tr>
          </thead>
          <tbody>
            {% for imppiez in imppiezs %}
                <tr>
                    <td scope="row">{{imppiez.impresion.fecha}}</td>
                    <td>{{imppiez.pieza.nombre}}</td>
                    <td>{{imppiez.cantidad}}</td>
                </tr>
            {% endfor %}
        </table>
    </div>
</div>

<div class="card card-body bg-light">
    <h3 class="card-header">Registrar impresi√≥n</h3>
    <div class="card-block">
        <form novalidate style="padding-top:10px" id="newImpForm" method="POST">
            <div class="form-group row">
                <div class="col-sm-6">
                    <input type="text" name="fecha" id="date" class="form-control" placeholder="Fecha" required="required" readonly>
                </div>
                <div class="col-sm-6">
                    <input type="time" name="hora" class="form-control" placeholder="Hora" required="required" readonly>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-sm-8">
                    <select class="form-control select2-single select2-hidden-accessible" name="pieza" required>
				        <option></option>
                    </select>
                    <div class="invalid-feedback">
                        Elija una pieza
                    </div>
                </div>
                <div class="col-sm-4">
                    <input type="number" name="cantidad" class="form-control" placeholder="#" required min="1" max="99999">
                </div>
            </div>
            <div class="form-group row">
                <div class="col-sm-4">
                    <button type="button" id="btnAdd" class="btn btn-success btn-block">+ Piezas</button>
                </div>
                <div class="col-sm-8">
                    <button type="submit" class="btn btn-primary btn-block"">Registrar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript">
$(function() {
    $('input#date').val("{{nowfecha}}");
    $('input[type=time]').val("{{nowtiempo}}");
    piezasdata = [
        {% for piez in piezs %}
            {
                "id": {{piez.id}},
                "text": "{{piez.nombre}}"
            }
            {% if not loop.last %},{% endif %}
        {% endfor %}
    ]

    $('.select2-single').select2({
        allowClear: true,
        placeholder: 'Pieza',
        width: '100%',
        data: piezasdata
    });

    $('#btnAdd').click(function(){
        $('.form-group.row').last().before('\
            <div class="form-group row">\
                <div class="col-sm-8">\
                    <select name="pieza" class="form-control select2-single select2-hidden-accessible" required>\
                        <option></option>\
                    </select>\
                    <div class="invalid-feedback">\
                        Elija una pieza\
                    </div>\
                </div>\
                <div class="col-sm-3">\
                    <input type="number" name="cantidad" class="form-control" placeholder="#" required min="1" max="99999">\
                </div>\
                <div class="col-sm-1" style="padding-left: 0px;">\
                    <button type="button" class="btn btn-danger btn-block" onclick="$(this).parent().parent().remove()">-</button>\
                </div>\
            </div>\
        ');
        $('.select2-single').last().select2({
            allowClear: true,
            placeholder: 'Pieza',
            width: '100%',
            data: piezasdata
        });
    });

    // html5 constraints - https://www.w3.org/TR/html5/sec-forms.html#constraints
    // bs4 form validation - https://getbootstrap.com/docs/4.0/components/forms/#validation
    var formvalidtout;
    var forms = document.forms;
    // Loop over them and prevent submission
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
        if (formvalidtout)
            clearTimeout(formvalidtout);
        formvalidtout = setTimeout( function(){ form.classList.remove('was-validated'); } , 3000 );
      }, false);
    });

    /*// JQuery-validation + Bootstrap - https://jqueryvalidation.org/files/demo/bootstrap/index.html
    $( "#newImpForm" ).validate( {
        highlight: function ( element, errorClass, validClass ) {
            $( element ).addClass( "is-invalid" )
            //$( element ).parents( ".col-sm-5" ).addClass( "has-error" ).removeClass( "has-success" );
        },
        unhighlight: function (element, errorClass, validClass) {
            $( element ).removeClass( "is-invalid" )
            //$( element ).parents( ".col-sm-5" ).addClass( "has-success" ).removeClass( "has-error" );
        },

        div class="invalid-feedback">
    } )*/
});
</script>
{% endblock %}